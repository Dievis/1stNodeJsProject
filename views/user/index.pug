extends layout

block content
  // Hero Section
  section.hero.bg-primary.text-white.py-5.shadow
    .container.text-center
      h1.display-4.mb-3 Welcome to Home Consumer Products!
      p.lead.fs-5 Find the best products for your home at unbeatable prices.

  // Products Section
  section.products.bg-light.py-5
    .container
      h2.text-center.mb-5.text-dark Featured Products
      if products.length > 0
        .row.row-cols-1.row-cols-sm-2.row-cols-md-3.g-4
          each product in products
            .col
              .card.h-100.shadow.border-0.rounded-4.position-relative.hover-shadow
                .product-image.position-relative.overflow-hidden.rounded-top
                  img.card-img-top.object-fit-cover(style="height: 200px;", src=product.imgURL || 'https://via.placeholder.com/500x500', alt=product.name)
                .card-body.bg-white
                  h5.card-title.text-primary #{product.name}
                  p.card-text.text-muted Category: #{product.category ? product.category.name : 'Uncategorized'}
                  p.card-text.fs-5.text-success.mt-2 $#{product.price}
                .card-footer.bg-white.border-0.text-center
                  a.btn.btn-outline-primary.rounded-pill(href=`/products/${product._id}`) View Details
                  button.btn.favorite-btn.ms-2.rounded-circle.px-2.bg-warning.border-0(type='button', data-id=product._id, title='Add to favorites')
                    if userFavorites && userFavorites.includes(product._id.toString())
                      i.fas.fa-heart.text-danger 
                    else
                      i.far.fa-heart 
                  button.btn.btn-success.ms-2.rounded-circle.px-2.add-to-cart-btn(type='button', data-id=product._id, title='Add to cart')
                    i.fas.fa-plus 
      else
        p.text-center.text-muted No products available.

  // Vouchers Section
  section.vouchers.bg-white.py-5
    .container
      h2.text-center.mb-5.text-dark Available Vouchers
      if vouchers.length > 0
        .row.row-cols-1.row-cols-sm-2.row-cols-md-3.g-4
          each voucher in vouchers
            .col
              .card.h-100.shadow.border-0.rounded-4.position-relative.hover-shadow
                .card-body.bg-white
                  h5.card-title.text-primary #{voucher.name}
                  p.card-text.text-muted
                    | M√£: #{voucher.code}
                    br
                    | Gi·∫£m gi√°: #{voucher.discountPercentage}% (T·ªëi ƒëa: #{voucher.maximumDiscount}‚Ç´)
                    br
                    | H·∫°n s·ª≠ d·ª•ng: #{voucher.expirationDate.toLocaleDateString()}
                .card-footer.bg-white.border-0.text-center
                  button.btn.btn-outline-primary.rounded-pill(type='button', data-id=voucher._id) S·ª≠ d·ª•ng Voucher
      else
        p.text-center.text-muted No vouchers available.

block scripts
  script.
    document.addEventListener('DOMContentLoaded', () => {
      const favButtons = document.querySelectorAll('.favorite-btn');
      favButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
          const icon = btn.querySelector('i');
          const productId = btn.getAttribute('data-id');
          const isFavorite = icon.classList.contains('text-danger'); 

          try {
            if (isFavorite) {
              await fetch(`/favorites/${productId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
              });
            } else {
              await fetch(`/favorites`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId })
              });
            }

            icon.classList.toggle('text-danger'); 
            icon.classList.toggle('fas'); 
            icon.classList.toggle('far'); 
          } catch (error) {
            console.error('Error updating favorites:', error);
          }
        });
      });

      // X·ª≠ l√Ω s·ª± ki·ªán th√™m v√†o gi·ªè h√†ng
      const cartButtons = document.querySelectorAll('.add-to-cart-btn');
      cartButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
          const productId = btn.getAttribute('data-id');

          try {
            const response = await fetch('/carts/add', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ productId, quantity: 1 })
            });

            if (response.ok) {
              alert('üõí S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c th√™m v√†o gi·ªè h√†ng!');
            } else {
              const result = await response.json();
              alert('‚ùå Kh√¥ng th·ªÉ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng: ' + result.message);
            }
          } catch (error) {
            console.error('Error adding to cart:', error);
            alert('‚ö†Ô∏è ƒê√£ x·∫£y ra l·ªói khi th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng.');
          }
        });
      });

      const useVoucherButtons = document.querySelectorAll('.btn-outline-primary');
      useVoucherButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
          const voucherId = btn.getAttribute('data-id');
          const userId = '#{user._id}'; // L·∫•y userId t·ª´ server-side

          console.log('Sending voucherId:', voucherId);
          console.log('Sending userId:', userId);

          try {
            const response = await fetch(`/vouchers/redeem`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ voucherId, userId })
            });

            if (response.ok) {
              alert('üéâ Voucher ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng th√†nh c√¥ng!');
            } else {
              const result = await response.json();
              alert('‚ùå Kh√¥ng th·ªÉ s·ª≠ d·ª•ng voucher: ' + result.message);
            }
          } catch (error) {
            console.error('Error using voucher:', error);
            alert('‚ö†Ô∏è ƒê√£ x·∫£y ra l·ªói khi s·ª≠ d·ª•ng voucher.');
          }
        });
      });
    });
