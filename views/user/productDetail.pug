extends layout

block content
  section.product-detail.bg-light.py-5
    .container
      if product
        .row
          .col-md-6
            img.img-fluid.rounded.shadow-lg(src=product.imgURL || 'https://via.placeholder.com/500x500', alt=product.name)
          .col-md-6
            h2.text-primary.mb-3 #{product.name}
            p.text-muted.mb-1 Category: #{product.category ? product.category.name : 'Uncategorized'}
            p.fs-4.text-success.mb-3 GiÃ¡: $#{product.price}
            if product.discount > 0
              p.text-danger.mb-3 Giáº£m giÃ¡: #{product.discount}%
            p.mb-4 MÃ´ táº£: #{product.description || 'KhÃ´ng cÃ³ mÃ´ táº£.'}
            p.mb-3 ÄÃ¡nh giÃ¡: #{product.rating} â­ (#{product.ratingCount} lÆ°á»£t Ä‘Ã¡nh giÃ¡)
            p.mb-3 Sá»‘ lÆ°á»£ng cÃ²n láº¡i: #{product.quantity}
            .d-flex.gap-3
              button.btn.btn-success.rounded-pill.add-to-cart-btn(data-id=product._id) 
                i.fas.fa-cart-plus.me-1
                | ThÃªm vÃ o giá» hÃ ng
              button.btn.btn-warning.rounded-circle.favorite-btn(data-id=product._id, title='Add to favorites')
                if userFavorites && userFavorites.includes(product._id.toString())
                  i.fas.fa-heart.text-danger
                else
                  i.far.fa-heart

        section.reviews-section.mt-5
          h3 ÄÃ¡nh giÃ¡ sáº£n pháº©m
          if reviews && reviews.length > 0
            .list-group
              each review in reviews
                .list-group-item
                  p.text-muted - #{review.user.username} Ä‘Ã¡nh giÃ¡:
                  p.mb-1
                    | #{review.comment}
                  p.rating
                    | ÄÃ¡nh giÃ¡: #{review.rating} â­
                  if user && user._id.toString() === review.user._id.toString()
                    button.btn.btn-sm.btn-danger.delete-review-btn(data-review-id=review._id) XÃ³a
          else
            p.text-muted ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡ nÃ o cho sáº£n pháº©m nÃ y.

          if user
            form#review-form(method='POST', action='/reviews')
              input(type='hidden', name='productId', value=product._id)
              .mb-3
                label(for='rating') Chá»n Ä‘Ã¡nh giÃ¡:
                select#rating.form-select(name='rating')
                  option(value='1') 1 â­
                  option(value='2') 2 â­
                  option(value='3') 3 â­
                  option(value='4') 4 â­
                  option(value='5') 5 â­
              .mb-3
                label(for='comment') BÃ¬nh luáº­n:
                textarea#comment.form-control(name='comment', rows='4')
              button.btn.btn-primary(type='submit') Gá»­i Ä‘Ã¡nh giÃ¡
          else
            p.text-muted Äá»ƒ Ä‘Ã¡nh giÃ¡ sáº£n pháº©m, vui lÃ²ng Ä‘Äƒng nháº­p.

      else
        p.text-center.text-danger Sáº£n pháº©m khÃ´ng tá»“n táº¡i hoáº·c Ä‘Ã£ bá»‹ xÃ³a.

block scripts
  script.
    document.addEventListener('DOMContentLoaded', () => {
      // Xá»­ lÃ½ nÃºt thÃªm Ä‘Ã¡nh giÃ¡
      const reviewForm = document.querySelector('#review-form');
      if (reviewForm) {
        const clonedForm = reviewForm.cloneNode(true);
        reviewForm.replaceWith(clonedForm);

        clonedForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const formData = new FormData(clonedForm);
          const body = {
            productId: formData.get('productId'),
            rating: formData.get('rating'),
            comment: formData.get('comment')
          };

          try {
            const response = await fetch('/reviews', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(body)
            });

            const result = await response.json();
            if (result.success) {
              alert('ÄÃ¡nh giÃ¡ cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c thÃªm!');
              location.reload();
            } else {
              alert('ThÃªm Ä‘Ã¡nh giÃ¡ tháº¥t báº¡i: ' + result.message);
            }
          } catch (error) {
            console.error('Error adding review:', error);
            alert('ÄÃ£ xáº£y ra lá»—i khi thÃªm Ä‘Ã¡nh giÃ¡.');
          }
        });
      }

      // Xá»­ lÃ½ nÃºt xÃ³a Ä‘Ã¡nh giÃ¡
      document.querySelectorAll('.delete-review-btn').forEach((button) => {
        const clonedButton = button.cloneNode(true);
        button.replaceWith(clonedButton);

        clonedButton.addEventListener('click', async (e) => {
          const reviewId = clonedButton.getAttribute('data-review-id');
          if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a Ä‘Ã¡nh giÃ¡ nÃ y?')) {
            try {
              const response = await fetch(`/reviews/${reviewId}`, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json'
                }
              });

              const result = await response.json();
              if (result.success) {
                alert('ÄÃ¡nh giÃ¡ cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c xÃ³a!');
                location.reload();
              } else {
                alert('XÃ³a Ä‘Ã¡nh giÃ¡ tháº¥t báº¡i: ' + result.message);
              }
            } catch (error) {
              console.error('Error deleting review:', error);
              alert('ÄÃ£ xáº£y ra lá»—i khi xÃ³a Ä‘Ã¡nh giÃ¡.');
            }
          }
        });
      });

      // Xá»­ lÃ½ nÃºt thÃªm vÃ o giá» hÃ ng
      const addToCartBtn = document.querySelector('.add-to-cart-btn');
      if (addToCartBtn) {
        const clonedAddToCartBtn = addToCartBtn.cloneNode(true);
        addToCartBtn.replaceWith(clonedAddToCartBtn);

        clonedAddToCartBtn.addEventListener('click', async (e) => {
          const productId = clonedAddToCartBtn.getAttribute('data-id');

          try {
            const response = await fetch('/carts/add', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ productId, quantity: 1 })
            });

            if (response.ok) {
              alert('ðŸ›’ Sáº£n pháº©m Ä‘Ã£ Ä‘Æ°á»£c thÃªm vÃ o giá» hÃ ng!');
            } else {
              const result = await response.json();
              alert('âŒ KhÃ´ng thá»ƒ thÃªm sáº£n pháº©m vÃ o giá» hÃ ng: ' + result.message);
            }
          } catch (error) {
            console.error('Error adding to cart:', error);
            alert('âš ï¸ ÄÃ£ xáº£y ra lá»—i khi thÃªm sáº£n pháº©m vÃ o giá» hÃ ng.');
          }
        });
      }

      // Xá»­ lÃ½ nÃºt yÃªu thÃ­ch
      const favoriteBtn = document.querySelector('.favorite-btn');
      if (favoriteBtn) {
        const clonedFavoriteBtn = favoriteBtn.cloneNode(true);
        favoriteBtn.replaceWith(clonedFavoriteBtn);

        clonedFavoriteBtn.addEventListener('click', async (e) => {
          const icon = clonedFavoriteBtn.querySelector('i');
          const productId = clonedFavoriteBtn.getAttribute('data-id');
          const isFavorite = icon.classList.contains('text-danger');

          try {
            if (isFavorite) {
              const response = await fetch(`/favorites/${productId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
              });
              if (response.ok) {
                icon.classList.remove('text-danger', 'fas');
                icon.classList.add('far');
              } else {
                const result = await response.json();
                alert('âŒ KhÃ´ng thá»ƒ xÃ³a sáº£n pháº©m khá»i danh sÃ¡ch yÃªu thÃ­ch: ' + result.message);
              }
            } else {
              const response = await fetch(`/favorites`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId })
              });
              if (response.ok) {
                icon.classList.add('text-danger', 'fas');
                icon.classList.remove('far');
              } else {
                const result = await response.json();
                alert('âŒ KhÃ´ng thá»ƒ thÃªm sáº£n pháº©m vÃ o danh sÃ¡ch yÃªu thÃ­ch: ' + result.message);
              }
            }
          } catch (error) {
            console.error('Error updating favorites:', error);
            alert('âš ï¸ ÄÃ£ xáº£y ra lá»—i khi cáº­p nháº­t danh sÃ¡ch yÃªu thÃ­ch.');
          }
        });
      }

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
          e.preventDefault();
        }
      });
    });


